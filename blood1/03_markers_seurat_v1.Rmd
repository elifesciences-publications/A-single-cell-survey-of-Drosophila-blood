---
title: "Cluster Markers"
author: "`r getOption('author')`"
date: "`r Sys.Date()`"
bibliography: bibliography.bib
---

```{r setup, include=FALSE}
source("setup.R")
library(Seurat)
library(tidyverse)
load("data/seurat.rda")
```

```{r header, child="_header.Rmd"}
```



```{r functions}
plot_clusters <- function(seurat, genes) {
    VlnPlot(seurat, genes,
            use.scaled = TRUE)
    FeaturePlot(seurat, genes,
                reduction.use = "tsne",
                cols.use = c("grey", "blue"))
    FeaturePlot(seurat, genes,
                reduction.use = "pca",
                cols.use = c("grey", "red"))
}

top_markers <- function(markers, n = 4) {
    markers %>%
        group_by(cluster) %>%
        top_n(n, avg_diff) %>%
        as.data.frame
}
```



```{r known_markers}
known_markers <- readxl::read_excel("meta/known_markers.xlsx") %>% camel
saveData(known_markers)
kable(known_markers, caption = "Known marker genes")
```



# Find differentially expressed genes (cluster biomarkers)

Seurat can help you find markers that define clusters via differential expression. By default, it identifes positive and negative markers of a single cluster, compared to all other cells. `FindAllMarkers()` automates this process for all clusters, but you can also test groups of clusters vs. each other, or against all cells.

The `min.pct` argument requires a gene to be detected at a minimum percentage in either of the two groups of cells, and the `thresh.test` argument requires a gene to be differentially expressed (on average) by some amount between the two groups. As another option to speed up these computations, `max.cells.per.ident` can be set. This will downsample each identity class to have no more cells than whatever this is set to. While there is generally going to be a loss in power, the speed increases can be signficiant and the most highly differentially expressed genes will likely still rise to the top.

Seurat has four tests for differential expression which can be set with the `test.use` parameter: LRT test based on zero-inflated data (`bimod`, default), ROC test (`roc`), t-test (`t`), LRT test based on tobit-censoring models (`tobit`) The ROC test returns the 'classification power' for any individual marker (ranging from 0 - random, to 1 - perfect).

```{r markers}
markers <- FindAllMarkers(seurat, only.pos = TRUE)
saveData(markers)
```


## Known markers detected

Let's obtain the statistics on our known marker genes from [Seurat][]. Previously identified marker genes from all 4 cell types were detected in the analysis.

```{r known_markers_detected}
known_markers_detected <- left_join(
    markers,
    known_markers,
    by = c("gene" = "symbol")) %>%
    filter(!is.na(cell))
kable(known_markers_detected, caption = "Known markers detected")
```


## Top markers per cluster

```{r top}
top <- top_markers(markers)
kable(top, caption = "Top markers per cluster")
```



# Visualization

## Cluster heterogeneity

Heatmaps can also be a good way to examine heterogeneity within/between clusters. The `DoHeatmap()` function will generate a heatmap for given cells and genes. In this case, we are plotting the top markers for each cluster.

```{r do_heatmap}
DoHeatmap(
    seurat,
    genes.use = top$gene,
    remove.key = TRUE,
    slim.col.label = TRUE)
```


## Cluster marker plots

There are several tools for visualizing marker expression. `VlnPlot()` generates a violin plot which shows the probability density at different expression levels of the gene for each cluster. As seen below, good marker genes will show strongly in a single cluster. It can also be useful to look at gene/gene correlation with `GenePlot()` which returns a plot similar to a 'FACS' plot with cells colored by cluster identity. Also, the `FeaturePlot()` function is useful for viewing the expression of the gene in the context of all the cells and helps validate the specificity of the marker or the quality of the clustering.


## Cluster specificity of known markers

```{r specificity, results="asis"}
list <- lapply(seq_along(cell_types), function(a) {
    writeLines(
        c("", "",
          paste("###", cell_types[a]),
          "", ""))
    genes <- known_markers_detected %>%
        .[.$cell_type == cell_types[a], "gene"] %>% unique %>% sort
    plot_clusters(seurat, genes)
}) %>% invisible
```


## Top markers per cluster

```{r top_markers, results="asis"}
lapply(levels(top$cluster), function(a) {
    writeLines(
        c("", "",
          paste("###", "Cluster", a),
          "", ""))
    genes <- top %>% .[.$cluster == a, "gene"]
    plot_clusters(seurat, genes)
}) %>% invisible
```



```{r footer, child="_footer.Rmd"}
```
