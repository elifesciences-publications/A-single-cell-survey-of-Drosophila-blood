---
title: "uninjured_injured_integration"
author: "Victor Barrera"
date: ""
output: html_document
params:
    vars_to_regress: !r c("nFeature_RNA","percent.mito")
    outputDir: "."
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r message=FALSE ,warning = FALSE}
# Shared R Markdown settings
if (file.exists("_setup.R")) {
    source("_setup.R")
}
```

```{r}
# Create folders
resultsDir <- file.path(params$outputDir, "results",Sys.Date())
invisible(mapply(
    FUN = dir.create,
    list(resultsDir),
    MoreArgs = list(recursive = TRUE, showWarnings = FALSE)
))


```

```{r}
# Specify seed for reproducibility
set.seed(1234567890)
```

```{r check-library-functions, echo=FALSE, message=FALSE}
# function to check installed libraries
check_install = function(packages) {
    not_installed = setdiff(packages, rownames(installed.packages()))
    if (length(not_installed) > 0) {
        write(paste("The libraries", not_installed, "are not installed, aborting.",
                    sep = " "), stderr())
        stop()
    }
}
```

```{r load-libraries, echo=FALSE, message=FALSE, warning=FALSE}
# load requiered library after checking if installed
packages = c("Seurat", "reticulate","AnnotationHub","ggplot2","cowplot")
check_install(packages)
installed = lapply(packages, library, character.only = TRUE)
```

```{r}
# load conda environment that contains umap-learning for umap plots
use_condaenv("bioPython", conda = "/Users/victorbarrera/software/miniconda2/bin/conda", required = TRUE)
```

```{r}
ah <- AnnotationHub()
ahDb <- query(ah, pattern = c("Drosophila Melanogaster","EnsDb") )

id <- ahDb %>% 
     mcols() %>%  
        rownames() %>%
        tail(n = 1)

## Download the appropriate Ensembldb database
ahEnsdb <- ahDb[[id]]

rows <- genes(ahEnsdb)  %>% 
    as.data.frame() %>% 
    dplyr::mutate(gene_name = toupper(gene_name)) %>% 
    dplyr::select(c(gene_id,gene_name))
```

```{r, load-data}
# Injured

## 10x samples
B2.data <- Read10X(data.dir = "./data/injured/10x/B2")
pre_regressed_B2 <- CreateSeuratObject(counts = B2.data, min.cells = 10, min.features = 100, project = "10X_injured_B2")
mito.features <- grep(pattern = "^MT-", x = rownames(x = pre_regressed_B2), value = TRUE)
percent.mito <- Matrix::colSums(x = GetAssayData(object = pre_regressed_B2, slot = 'counts')[mito.features, ]) / Matrix::colSums(x = GetAssayData(object = pre_regressed_B2, slot = 'counts'))
total_reads <- Matrix::colSums(GetAssayData(pre_regressed_B2, slot = "counts"))
pre_regressed_B2[['percent.mito']] <- percent.mito
pre_regressed_B2[['total_reads']] <- total_reads
pre_regressed_B2$tech <- "10x"
pre_regressed_B2$injured_st <- "injured"
pre_regressed_B2$sample <- "B2"


B4.data <- Read10X(data.dir = "./data/injured/10x/B4")
pre_regressed_B4 <- CreateSeuratObject(counts = B4.data, min.cells = 10, min.features = 100, project = "10X_injured_B4")
mito.features <- grep(pattern = "^MT-", x = rownames(x = pre_regressed_B4), value = TRUE)
percent.mito <- Matrix::colSums(x = GetAssayData(object = pre_regressed_B4, slot = 'counts')[mito.features, ]) / Matrix::colSums(x = GetAssayData(object = pre_regressed_B4, slot = 'counts'))
total_reads <- Matrix::colSums(GetAssayData(pre_regressed_B4, slot = "counts"))
pre_regressed_B4[['percent.mito']] <- percent.mito
pre_regressed_B4[['total_reads']] <- total_reads
pre_regressed_B4$tech <- "10x"
pre_regressed_B4$injured_st <- "injured"
pre_regressed_B4$sample <- "B4"

## Indrop samples
Indrop.data_inj <- read.delim("./data/injured/indrop/counts_project4.txt",header = T,row.names = 1)
pre_regressed_Indrop_inj <- CreateSeuratObject(counts = Indrop.data_inj, min.cells = 10, min.features = 100, project = "Indrop_injured")
#pre_regressed_Indrop_inj$orig.ident <- "Indrop_injured"
# We use the same genes that the ones used in the 10x set
mito_genes <- gsub("MT-","",mito.features)[gsub("MT-","",mito.features) %in% rownames(pre_regressed_Indrop_inj)] 
percent.mito <- Matrix::colSums(x = GetAssayData(object = pre_regressed_Indrop_inj, slot = 'counts')[mito_genes, ]) / Matrix::colSums(x = GetAssayData(object = pre_regressed_Indrop_inj, slot = 'counts'))
total_reads <- Matrix::colSums(GetAssayData(pre_regressed_Indrop_inj, slot = "counts"))
pre_regressed_Indrop_inj[['percent.mito']] <- percent.mito
pre_regressed_Indrop_inj[['total_reads']] <- total_reads
pre_regressed_Indrop_inj$tech <- "Indrop"
pre_regressed_Indrop_inj$injured_st <- "injured"
pre_regressed_Indrop_inj$sample <- "Indrop_inj"

## Metadata

metadata_injured <- read.csv("./metadata/injured/metadata.csv",header = T)
colnames(metadata_injured) <- gsub("barcodes","barcode",colnames(metadata_injured))
metadata_injured$injured_st <- "injured"

# Uninjured

## 10x samples
B1.data <- Read10X(data.dir = "./data/uninjured/10x/B1/")
pre_regressed_B1 <- CreateSeuratObject(counts = B1.data, min.cells = 10, min.features = 100, project = "10X_uninjured_B1")
mito.features <- grep(pattern = "^MT-", x = rownames(x = pre_regressed_B1), value = TRUE)
percent.mito <- Matrix::colSums(x = GetAssayData(object = pre_regressed_B1, slot = 'counts')[mito.features, ]) / Matrix::colSums(x = GetAssayData(object = pre_regressed_B1, slot = 'counts'))
total_reads <- Matrix::colSums(GetAssayData(pre_regressed_B1, slot = "counts"))
pre_regressed_B1[['percent.mito']] <- percent.mito
pre_regressed_B1[['total_reads']] <- total_reads
pre_regressed_B1$tech <- "10x"
pre_regressed_B1$injured_st <- "uninjured"
pre_regressed_B1$sample <- "B1"


B3.data <- Read10X(data.dir = "./data/uninjured/10x/B3")
pre_regressed_B3 <- CreateSeuratObject(counts = B3.data, min.cells = 10, min.features = 100, project = "10X_uninjured_B3")
mito.features <- grep(pattern = "^MT-", x = rownames(x = pre_regressed_B3), value = TRUE)
percent.mito <- Matrix::colSums(x = GetAssayData(object = pre_regressed_B3, slot = 'counts')[mito.features, ]) / Matrix::colSums(x = GetAssayData(object = pre_regressed_B3, slot = 'counts'))
total_reads <- Matrix::colSums(GetAssayData(pre_regressed_B3, slot = "counts"))
pre_regressed_B3[['percent.mito']] <- percent.mito
pre_regressed_B3[['total_reads']] <- total_reads
pre_regressed_B3$tech <- "10x"

pre_regressed_B3$injured_st <- "uninjured"
pre_regressed_B3$sample <- "B3"

## Indrop samples
Indrop.data_uninj <- read.delim("./data/uninjured/indrop/indrop_p2.txt",header = T,row.names = 1)
pre_regressed_Indrop_uninj <- CreateSeuratObject(counts = Indrop.data_uninj, min.cells = 10, min.features = 100, project = "Indrop_uninjured")
Indrop.data_uninj_PC2



#pre_regressed_Indrop_uninj$orig.ident <- "Indrop_uninjured"
# We use the same genes that the ones used in the 10x set
mito_genes <- gsub("MT-","",mito.features)[gsub("MT-","",mito.features) %in% rownames(pre_regressed_Indrop_uninj)] 
percent.mito <- Matrix::colSums(x = GetAssayData(object = pre_regressed_Indrop_uninj, slot = 'counts')[mito_genes, ]) / Matrix::colSums(x = GetAssayData(object = pre_regressed_Indrop_uninj, slot = 'counts'))
total_reads <- Matrix::colSums(GetAssayData(pre_regressed_Indrop_uninj, slot = "counts"))
pre_regressed_Indrop_uninj[['percent.mito']] <- percent.mito
pre_regressed_Indrop_uninj[['total_reads']] <- total_reads
pre_regressed_Indrop_uninj$tech <- "Indrop"
pre_regressed_Indrop_uninj$injured_st <- "uninjured"
pre_regressed_Indrop_uninj$sample <- "Indrop_uninj"

## Metadata
metadata_uninjured <- read.csv("./metadata/uninjured/metadata.csv",header = T)
metadata_uninjured$injured_st <- "uninjured"
```



```{r}
# merge samples
pre_regress_all_data <- merge(x = pre_regressed_B2 ,y = c(pre_regressed_B4, pre_regressed_Indrop_inj, pre_regressed_B1, pre_regressed_B3, pre_regressed_Indrop_uninj), 
                              add.cell.id = c("B2","B4","Ind_inj","B1","B3","Ind_uninj"))
# Integration
pre_regress_all_data_list <- SplitObject(object = pre_regress_all_data, split.by = "sample")
```


# QC {.tabset}

```{r, results = "asis"}
for (i in 1:length(x = pre_regress_all_data_list)) {
    cat("\n")
    cat("##",names(pre_regress_all_data_list)[i], "{.tabset} \n")
    cat("###  Number of genes - Number of UMIs and mitocondrial percentage \n")
        p <- VlnPlot(object = pre_regress_all_data_list[[i]], features = c("nFeature_RNA", "nCount_RNA", "percent.mito"), ncol = 3)
        print(p)
    cat("\n")
    cat("\n###  nUmi-mito. perc\n")
        par(mfrow = c(1, 1))
        p <- FeatureScatter(object = pre_regress_all_data_list[[i]], feature1 = "nCount_RNA", feature2 = "percent.mito")
        print(p)
    cat("\n")
    cat("\n### Genes detected per cell \n")
        p <- pre_regress_all_data_list[[i]]@meta.data %>% 
        ggplot(aes(x=orig.ident, y=log10(nFeature_RNA), fill=orig.ident)) + 
        geom_boxplot() + 
        ggtitle("nFeature_RNA")
        print(p)
    cat("\n")
    cat("\n### nGenes vs total reads\n")
        p <- pre_regress_all_data_list[[i]]@meta.data %>% 
        ggplot(aes(x=log10(nFeature_RNA), y=log10(total_reads), fill=orig.ident)) + 
        geom_point() + 
        ggtitle("nFeature_RNA vs total reads")
        print(p)
    cat("\n")
    cat("\n### nUMI vs nGenes\n")
        p <- pre_regress_all_data_list[[i]]@meta.data %>% 
        ggplot(aes(x=nCount_RNA, y=nFeature_RNA, color=percent.mito)) + 
        geom_point() + 
        stat_smooth(method=lm) +
        scale_x_log10() + 
        scale_y_log10() + 
        geom_vline(xintercept = 800) +
        facet_wrap(~orig.ident)
        print(p)
    cat("\n")
}
```


# Filter
```{r filtering, eval = FALSE}
# We filter using threshold values based on the previous QC
pre_regress_all_data_list$B2 <- subset(x = pre_regress_all_data_list$B2, subset = (nFeature_RNA > 250 & nFeature_RNA < 2000) & (percent.mito < 0.2) & (nCount_RNA > 250 & nCount_RNA < 5000))
pre_regress_all_data_list$B4<- subset(x = pre_regress_all_data_list$B4, subset = (nFeature_RNA > 250  & nFeature_RNA < 2000) & (percent.mito < 0.2) & (nCount_RNA > 250 & nCount_RNA < 5000))
pre_regress_all_data_list$Indrop_inj <- subset(x = pre_regress_all_data_list$Indrop_inj, subset = (nFeature_RNA > 500 & nFeature_RNA < 1500) & (percent.mito < 0.15) & (nCount_RNA > 2000 & nCount_RNA < 4000))
pre_regress_all_data_list$B1 <- subset(x = pre_regress_all_data_list$B1, subset = (nFeature_RNA > 250 & nFeature_RNA < 2000) & (percent.mito < 0.2) & (nCount_RNA > 250 & nCount_RNA < 5000))
pre_regress_all_data_list$B3 <- subset(x = pre_regress_all_data_list$B3, subset = (nFeature_RNA > 250 & nFeature_RNA < 2000) & (percent.mito < 0.2) & (nCount_RNA > 250 & nCount_RNA < 5000))
pre_regress_all_data_list$Indrop_uninj <- subset(x = pre_regress_all_data_list$Indrop_uninj, subset = (nFeature_RNA >  500 & nFeature_RNA < 1500) & (percent.mito < 0.15) & (nCount_RNA > 2000 & nCount_RNA < 4000))
```

# Post Filter QC {.tabset}

```{r, results = "asis"}
for (i in 1:length(x = pre_regress_all_data_list)) {
    cat("\n")
    cat("##",names(pre_regress_all_data_list)[i], "{.tabset} \n")
    cat("###  Number of genes - Number of UMIs and mitocondrial percentage \n")
        p <- VlnPlot(object = pre_regress_all_data_list[[i]], features = c("nFeature_RNA", "nCount_RNA", "percent.mito"), ncol = 3)
        print(p)
    cat("\n")
    cat("\n###  nUmi-mito. perc\n")
        par(mfrow = c(1, 1))
        p <- FeatureScatter(object = pre_regress_all_data_list[[i]], feature1 = "nCount_RNA", feature2 = "percent.mito")
        print(p)
    cat("\n")
    cat("\n### Genes detected per cell \n")
        p <- pre_regress_all_data_list[[i]]@meta.data %>% 
        ggplot(aes(x=orig.ident, y=log10(nFeature_RNA), fill=orig.ident)) + 
        geom_boxplot() + 
        ggtitle("nFeature_RNA")
        print(p)
    cat("\n")
    cat("\n### nGenes vs total reads\n")
        p <- pre_regress_all_data_list[[i]]@meta.data %>% 
        ggplot(aes(x=log10(nFeature_RNA), y=log10(total_reads), fill=orig.ident)) + 
        geom_point() + 
        ggtitle("nFeature_RNA vs total reads")
        print(p)
    cat("\n")
    cat("\n### nUMI vs nGenes\n")
        p <- pre_regress_all_data_list[[i]]@meta.data %>% 
        ggplot(aes(x=nCount_RNA, y=nFeature_RNA, color=percent.mito)) + 
        geom_point() + 
        stat_smooth(method=lm) +
        scale_x_log10() + 
        scale_y_log10() + 
        geom_vline(xintercept = 800) +
        facet_wrap(~orig.ident)
        print(p)
    cat("\n")
}
```


# Structure {.tabset}

```{r}
all_data.pre_integrated <- merge(x = pre_regress_all_data_list$B2 ,y = c(pre_regress_all_data_list$B4, pre_regress_all_data_list$Indrop_inj, pre_regress_all_data_list$B1, 
                                                                         pre_regress_all_data_list$B3, pre_regress_all_data_list$Indrop_uninj), 
                              add.cell.id = c("B2","B4","Ind_inj","B1","B3","Ind_uninj"))


all_data.pre_integrated<- NormalizeData(object = all_data.pre_integrated, verbose = FALSE)
all_data.pre_integrated <- FindVariableFeatures(object = all_data.pre_integrated, 
                                             selection.method = "vst", nfeatures = 2000, verbose = FALSE)

all_data.pre_integrated <- ScaleData(object = all_data.pre_integrated,vars.to.regress = params$vars_to_regress,verbose = FALSE)
all_data.pre_integrated <- RunPCA(object = all_data.pre_integrated, npcs = 30, verbose = FALSE)
all_data.pre_integrated <- RunUMAP(object = all_data.pre_integrated, reduction = "pca",dims = 1:30)
all_data.pre_integrated <- RunTSNE(object = all_data.pre_integrated, reduction = "pca",dims = 1:30)
```

## UMAP {.tabset}
```{r}
p1 <- DimPlot(object = all_data.pre_integrated, reduction = "umap", group.by = "sample")
p2 <- DimPlot(object = all_data.pre_integrated, reduction = "umap", group.by = "tech")
p3 <- DimPlot(object = all_data.pre_integrated, reduction = "umap", group.by = "injured_st")
```

### By sample

```{r}
show(p1)
```

### By tech

```{r}
show(p2)

```

### By injured status

```{r}
show(p3)
```

## TSNE {.tabset}

```{r}
p4 <- DimPlot(object = all_data.pre_integrated, reduction = "tsne", group.by = "sample")
p5 <- DimPlot(object = all_data.pre_integrated, reduction = "tsne", group.by = "tech")
p6 <- DimPlot(object = all_data.pre_integrated, reduction = "tsne", group.by = "injured_st")
```

### By sample

```{r}
show(p4)
```

### By tech

```{r}
show(p5)
```

### By injured status

```{r}
show(p6)
```

# Integrate

```{r}
for (i in 1:length(x = pre_regress_all_data_list)) {
  pre_regress_all_data_list[[i]] <- NormalizeData(object = pre_regress_all_data_list[[i]], verbose = FALSE)
  pre_regress_all_data_list[[i]] <- FindVariableFeatures(object = pre_regress_all_data_list[[i]], 
                                             selection.method = "vst", nfeatures = 2000, verbose = FALSE)
}
# finding anchors
reference.list <- pre_regress_all_data_list[c("B2","B4","Indrop_inj","B1","B3","Indrop_uninj")]
pre_regress_all_data.anchors <- FindIntegrationAnchors(object.list = reference.list, dims = 1:30)
pre_regress_all_data.integrated <- IntegrateData(anchorset = pre_regress_all_data.anchors, dims = 1:30)
DefaultAssay(object = pre_regress_all_data.integrated) <- "integrated"
all_data.integrated <- ScaleData(object = pre_regress_all_data.integrated,vars.to.regress = params$vars_to_regress,verbose = FALSE)
DefaultAssay(object = all_data.integrated) <- "integrated"
all_data.integrated <- RunPCA(object = all_data.integrated, npcs = 30, verbose = FALSE)
all_data.integrated <- RunUMAP(object = all_data.integrated, reduction = "pca",dims = 1:30)
all_data.integrated <- RunTSNE(object = all_data.integrated, reduction = "pca",dims = 1:30)
```

## UMAP {.tabset}
```{r}
p1 <- DimPlot(object = all_data.integrated, reduction = "umap", group.by = "sample")
p2 <- DimPlot(object = all_data.integrated, reduction = "umap", group.by = "tech")
p3 <- DimPlot(object = all_data.integrated, reduction = "umap", group.by = "injured_st")
```

### By sample

```{r}
show(p1)
```

### By tech

```{r}
show(p2)
```

### By injured status

```{r}
show(p3)
```

## TSNE {.tabset}

```{r}
p4 <- DimPlot(object = all_data.integrated, reduction = "tsne", group.by = "sample")
p5 <- DimPlot(object = all_data.integrated, reduction = "tsne", group.by = "tech")
p6 <- DimPlot(object = all_data.integrated, reduction = "tsne", group.by = "injured_st")
```

### By sample

```{r}
show(p4)
```

### By tech

```{r}
show(p5)
```

### By injured status

```{r}
show(p6)
```

# Clusters {.tabset}

```{r}
# clustering, finding maker genes
all_data.integrated <- FindNeighbors(object = all_data.integrated, dims = 1:30)
all_data.integrated <- FindClusters(object = all_data.integrated, resolution = 0.6)
```

## UMAP

```{r}
DimPlot(object = all_data.integrated, reduction = 'umap')
```

## TSNE

```{r}
DimPlot(object = all_data.integrated, reduction = 'tsne')
```

# Plot genes UMAP {.tabset}

```{r, results = 'asis'}

for (gene in c("FBgn0000299","FBgn0030362","FBgn0003124","FBgn0261385","FBgn0042106","FBgn0039759","FBgn0034010","FBgn0028517",
              "FBgn0033367","FBgn0035189","FBgn0001223","FBgn0013275","FBgn0267521","FBgn0267498","FBgn0029766","FBgn0032136",
              "FBgn0283461","FBgn0038530","FBgn0262952","FBgn0013676", "FBgn0033520","FBgn0033518","FBgn0040609","FBgn0001258",
              "FBgn0030073","FBgn0029002","FBgn0003888","FBgn0263080")){
    cat("\n")
    cat("##",gene,"\n")
    p <-  FeaturePlot(object = all_data.integrated, reduction = 'umap', features = c(gene), min.cutoff = 1)
    print(p)
    cat("\n")
}
```

# Plot genes t-SNE {.tabset}

```{r, results = 'asis'}

for (gene in c("FBgn0000299","FBgn0030362","FBgn0003124","FBgn0261385","FBgn0042106","FBgn0039759","FBgn0034010","FBgn0028517",
              "FBgn0033367","FBgn0035189","FBgn0001223","FBgn0013275","FBgn0267521","FBgn0267498","FBgn0029766","FBgn0032136",
              "FBgn0283461","FBgn0038530","FBgn0262952","FBgn0013676", "FBgn0033520","FBgn0033518","FBgn0040609","FBgn0001258",
              "FBgn0030073","FBgn0029002","FBgn0003888","FBgn0263080")){
    cat("\n")
    cat("##",gene,"\n")
    p <-  FeaturePlot(object = all_data.integrated, reduction = 'tsne', features = c(gene), min.cutoff = 1)
    print(p)
    cat("\n")
}
```


# Markers 

```{r}
selected_genes <- rio::import("./markers.csv")
```

Genes:

```{r}
DT::datatable(selected_genes)
```


# Plots-UMAP{.tabset}

```{r, results = "asis"}
selected_genes <- selected_genes %>% dplyr::filter(geneID %in% rownames(all_data.integrated))


selected_genes <- selected_genes[rowSums(as.matrix(GetAssayData(all_data.integrated)[selected_genes$geneID,]))>0,]

plot_feature_plot_wrapper <- function(obj,sub_df){
    p <- FeaturePlot(obj, features = sub_df[2],cols = c("grey", "blue"), 
reduction = "umap",min.cutoff = 1) + 
        ggtitle(sub_df[2]) %>% invisible()
    return(p)
}

for(cell_t in unique(selected_genes$cellType)){
    cat("\n")
    cat("##",cell_t," {.tabset} \n")
    df <- selected_genes %>% dplyr::filter(cellType == cell_t)
    df_split <- split(df, ceiling(seq_along(df$geneID)/6))
    for(i in names(df_split)){
        cat("\n")
        cat("###",paste(cell_t,i,sep="-"),"\n")
        
        plot_list <- apply(df_split[[i]],1,FUN = function(x){plot_feature_plot_wrapper(all_data.integrated,x)})
        
        
        p_l <- plot_grid(plotlist = plot_list,ncol = 2)
        print(p_l)
        cat("\n")
    }
    cat("\n")
}

```


# Plots-TSNE{.tabset}


```{r, results = "asis"}
plot_feature_plot_wrapper <- function(obj,sub_df){
    p <- FeaturePlot(obj, features = sub_df[2],cols = c("grey", "blue"), 
reduction = "tsne",min.cutoff = 1) + 
        ggtitle(sub_df[2]) %>% invisible()
    return(p)
}

for(cell_t in unique(selected_genes$cellType)){
    cat("\n")
    cat("##",cell_t," {.tabset} \n")
    df <- selected_genes %>% dplyr::filter(cellType == cell_t)
    df_split <- split(df, ceiling(seq_along(df$geneID)/6))
    for(i in names(df_split)){
        cat("\n")
        cat("###",paste(cell_t,i,sep="-"),"\n")
        
        plot_list <- apply(df_split[[i]],1,FUN = function(x){plot_feature_plot_wrapper(all_data.integrated,x)})
        
        
        p_l <- plot_grid(plotlist = plot_list,ncol = 2)
        print(p_l)
        cat("\n")
    }
    cat("\n")
}

```
