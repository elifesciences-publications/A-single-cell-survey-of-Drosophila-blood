---
title: "uninjured_injured_integration - Separated samples"
author: "Victor Barrera"
date: ""
output: html_document
params:
    vars_to_regress: !r c("nFeature_RNA","percent.mito")
    outputDir: "."
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r message=FALSE ,warning = FALSE}
# Shared R Markdown settings
if (file.exists("_setup.R")) {
    source("_setup.R")
}
```

```{r}
# Create folders
resultsDir <- file.path(params$outputDir, "results",Sys.Date())
invisible(mapply(
    FUN = dir.create,
    list(resultsDir),
    MoreArgs = list(recursive = TRUE, showWarnings = FALSE)
))


```

```{r}
# Specify seed for reproducibility
set.seed(1234567890)
```

```{r check-library-functions, echo=FALSE, message=FALSE}
'%!in%' <- function(x,y)!('%in%'(x,y))


# function to check installed libraries
check_install = function(packages) {
    not_installed = setdiff(packages, rownames(installed.packages()))
    if (length(not_installed) > 0) {
        write(paste("The libraries", not_installed, "are not installed, aborting.",
                    sep = " "), stderr())
        stop()
    }
}
```

```{r load-libraries, echo=FALSE, message=FALSE, warning=FALSE}
# load requiered library after checking if installed
packages = c("Seurat", "reticulate","AnnotationHub","ggplot2","cowplot")
check_install(packages)
installed = lapply(packages, library, character.only = TRUE)
```

```{r}
# load conda environment that contains umap-learning for umap plots
use_condaenv("bioPython", conda = "/Users/victorbarrera/software/miniconda2/bin/conda", required = TRUE)
```

```{r}
ah <- AnnotationHub()
ahDb <- query(ah, pattern = c("Drosophila Melanogaster","EnsDb") )

id <- ahDb %>% 
     mcols() %>%  
        rownames() %>%
        tail(n = 1)

## Download the appropriate Ensembldb database
ahEnsdb <- ahDb[[id]]

rows <- genes(ahEnsdb)  %>% 
    as.data.frame() %>% 
    dplyr::mutate(gene_name = toupper(gene_name)) %>% 
    dplyr::select(c(gene_id,gene_name))
```

```{r, load-data}
# Injured

## Metadata
## We use the metadata samples in order to choose the samples to use
metadata_injured <- read.csv("./metadata/injured/metadata.csv",header = T)
colnames(metadata_injured) <- gsub("barcodes","barcode",colnames(metadata_injured))

## 10x samples
B2.data <- Read10X(data.dir = "./data/injured/10x/B2")
B2_selected_cells <- metadata_injured %>% dplyr::filter(sample == "10X_injured_B2")%>% 
    dplyr::filter(barcode %in% colnames(B2.data))
B2_selected_cells$barcode <- as.character(B2_selected_cells$barcode)
selected_data <- B2.data[,B2_selected_cells$barcode]


B2_selected_cells$sample <- droplevels(B2_selected_cells$sample) 
pre_regressed_B2 <- CreateSeuratObject(counts = selected_data, min.cells = 10, min.features = 100, project = "10X_injured_B2")
pre_regressed_B2$tech <- "10x"
pre_regressed_B2$injured_st <- "injured"
pre_regressed_B2$sample <- "B2"


B4.data <- Read10X(data.dir = "./data/injured/10x/B4")
B4_selected_cells <- metadata_injured %>% dplyr::filter(sample == "10X_injured_B4") %>% 
    dplyr::filter(barcode %in% colnames(B4.data))
B4_selected_cells$sample <- droplevels(B4_selected_cells$sample) 
B4_selected_cells$barcode <- as.character(B4_selected_cells$barcode)
selected_data <- B4.data[,B4_selected_cells$barcode]


pre_regressed_B4 <- CreateSeuratObject(counts = selected_data, min.cells = 10, min.features = 100, project = "10X_injured_B4")
pre_regressed_B4$tech <- "10x"
pre_regressed_B4$injured_st <- "injured"
pre_regressed_B4$sample <- "B4"

## Indrop samples
Indrop.data_inj <- read.delim("./data/injured/indrop/counts_project4.txt",header = T,row.names = 1) %>% as.matrix()


Indrop_PC1_selected_cells <- metadata_injured %>% dplyr::filter(sample == "Indrop_PC1") %>% 
    dplyr::filter(barcode %in% colnames(Indrop.data_inj))
Indrop_PC1_selected_cells$barcode <- as.character(Indrop_PC1_selected_cells$barcode)
selected_data <- Indrop.data_inj[,Indrop_PC1_selected_cells$barcode]

pre_regressed_Indrop_PC1 <- CreateSeuratObject(counts = selected_data, min.cells = 10, min.features = 100, project = "Indrop_PC1")
pre_regressed_Indrop_PC1$tech <- "Indrop"
pre_regressed_Indrop_PC1$injured_st <- "injured"
pre_regressed_Indrop_PC1$sample <- "Indrop_PC1"



Indrop_PC2_1_selected_cells <- metadata_injured %>% dplyr::filter(sample == "Indrop_PC2_1") %>% 
    dplyr::filter(barcode %in% colnames(Indrop.data_inj))

Indrop_PC2_1_selected_cells$barcode <- as.character(Indrop_PC2_1_selected_cells$barcode)
selected_data <- Indrop.data_inj[,Indrop_PC2_1_selected_cells$barcode]

pre_regressed_Indrop_PC2_1 <- CreateSeuratObject(counts = selected_data, min.cells = 10, min.features = 100, project = "Indrop_PC2_1")
pre_regressed_Indrop_PC2_1$tech <- "Indrop"
pre_regressed_Indrop_PC2_1$injured_st <- "injured"
pre_regressed_Indrop_PC2_1$sample <- "Indrop_PC2_1"

```


```{r}
# Uninjured

## Metadata
## We use the metadata samples in order to choose the samples to use

metadata_uninjured <- read.csv("./metadata/uninjured/metadata.csv",header = T)
colnames(metadata_uninjured) <- gsub("barcodes","barcode",colnames(metadata_uninjured))

## 10x samples
B1.data <- Read10X(data.dir = "./data/uninjured/10x/B1/")
B1_selected_cells <- metadata_uninjured %>% dplyr::filter(sample == "10X_B1")%>% 
    dplyr::filter(barcode %in% colnames(B1.data))
B1_selected_cells$barcode <- as.character(B1_selected_cells$barcode)
selected_data <- B1.data[,B1_selected_cells$barcode]


pre_regressed_B1 <- CreateSeuratObject(counts = selected_data, min.cells = 10, min.features = 100, project = "10X_uninjured_B1")
pre_regressed_B1$tech <- "10x"
pre_regressed_B1$injured_st <- "uninjured"
pre_regressed_B1$sample <- "B1"


B3.data <- Read10X(data.dir = "./data/uninjured/10x/B3")
B3_selected_cells <- metadata_uninjured %>% dplyr::filter(sample == "10X_B3")%>% 
    dplyr::filter(barcode %in% colnames(B3.data))

B3_selected_cells$barcode <- as.character(B3_selected_cells$barcode)
selected_data <- B3.data[,B3_selected_cells$barcode]

pre_regressed_B3 <- CreateSeuratObject(counts = selected_data, min.cells = 10, min.features = 100, project = "10X_uninjured_B3")
pre_regressed_B3$tech <- "10x"
pre_regressed_B3$injured_st <- "uninjured"
pre_regressed_B3$sample <- "B3"


## Indrop samples
Indrop.data_uninj <- read.delim("./data/uninjured/indrop/indrop_p2.txt",header = T,row.names = 1) %>% as.matrix()


Indrop_blood2_uninj_selected_cells <- metadata_uninjured %>% dplyr::filter(sample == "blood2_TAAGGCTC") %>%
    dplyr::filter(barcode %in% colnames(Indrop.data_uninj))

Indrop_blood2_uninj_selected_cells$barcode <- as.character(Indrop_blood2_uninj_selected_cells$barcode)
selected_data <- Indrop.data_uninj[,Indrop_blood2_uninj_selected_cells$barcode]


pre_regressed_Indrop_blood2_uninj <- CreateSeuratObject(counts = selected_data, min.cells = 10, min.features = 100, project = "Indrop_blood2_uninj")

pre_regressed_Indrop_blood2_uninj$tech <- "Indrop"
pre_regressed_Indrop_blood2_uninj$injured_st <- "uninjured"
pre_regressed_Indrop_blood2_uninj$sample <- "Indrop_blood2_uninj"



Indrop_blood3_uninj_selected_cells <- metadata_uninjured %>% dplyr::filter(sample == "blood3_TAAGGCTC") %>%
    dplyr::filter(barcode %in% colnames(Indrop.data_uninj))

Indrop_blood3_uninj_selected_cells$barcode <- as.character(Indrop_blood3_uninj_selected_cells$barcode)
selected_data <- Indrop.data_uninj[,Indrop_blood3_uninj_selected_cells$barcode]

pre_regressed_Indrop_blood3_uninj <- CreateSeuratObject(counts = selected_data, min.cells = 10, min.features = 100, project = "Indrop_blood3_uninj")

pre_regressed_Indrop_blood3_uninj$tech <- "Indrop"
pre_regressed_Indrop_blood3_uninj$injured_st <- "uninjured"
pre_regressed_Indrop_blood3_uninj$sample <- "Indrop_blood3_uninj"
```



```{r}
# merge samples
pre_regress_all_data <- merge(x = pre_regressed_B2 ,y = c(pre_regressed_B4, pre_regressed_Indrop_PC1, 
                                                          pre_regressed_Indrop_PC2_1, pre_regressed_B1, pre_regressed_B3, pre_regressed_Indrop_blood2_uninj, pre_regressed_Indrop_blood3_uninj), 
                              add.cell.id = c("B2","B4","Ind_PC1","Ind_PC2_1","B1","B3","Ind_blood2","Ind_blood3"))
# Integration
pre_regress_all_data_list <- SplitObject(object = pre_regress_all_data, split.by = "sample")
```


# QC {.tabset}

```{r, results = "asis"}
for (i in 1:length(x = pre_regress_all_data_list)) {
    cat("\n")
    cat("##",names(pre_regress_all_data_list)[i], "{.tabset} \n")
    cat("###  Number of genes - Number of UMIs\n")
        p <- VlnPlot(object = pre_regress_all_data_list[[i]], features = c("nFeature_RNA", "nCount_RNA"), ncol = 2)
        print(p)
    cat("\n")
    cat("\n### Genes detected per cell \n")
        p <- pre_regress_all_data_list[[i]]@meta.data %>% 
        ggplot(aes(x=orig.ident, y=log10(nFeature_RNA), fill=orig.ident)) + 
        geom_boxplot() + 
        ggtitle("nFeature_RNA")
        print(p)
    cat("\n")
    cat("\n### nUMI vs nGenes\n")
        p <- pre_regress_all_data_list[[i]]@meta.data %>% 
        ggplot(aes(x=nCount_RNA, y=nFeature_RNA)) + 
        geom_point() + 
        stat_smooth(method=lm) +
        scale_x_log10() + 
        scale_y_log10() + 
        geom_vline(xintercept = 800) +
        facet_wrap(~orig.ident)
        print(p)
    cat("\n")
}
```


# Filter
```{r filtering, eval = FALSE}

for (i in 1:length(x = pre_regress_all_data_list)) {
  pre_regress_all_data_list[[i]] <-subset(x = pre_regress_all_data_list[[i]], subset = (nFeature_RNA > 500))

}

```

```{r, eval = FALSE}
# We filter using threshold values based on the previous QC
pre_regress_all_data_list$B2 <- subset(x = pre_regress_all_data_list$B2, subset = (nFeature_RNA > 250 & nFeature_RNA < 2000) & (percent.mito < 0.2) & (nCount_RNA > 250 & nCount_RNA < 5000))
pre_regress_all_data_list$B4<- subset(x = pre_regress_all_data_list$B4, subset = (nFeature_RNA > 250  & nFeature_RNA < 2000) & (percent.mito < 0.2) & (nCount_RNA > 250 & nCount_RNA < 5000))
pre_regress_all_data_list$Indrop_inj <- subset(x = pre_regress_all_data_list$Indrop_inj, subset = (nFeature_RNA > 500 & nFeature_RNA < 1500) & (percent.mito < 0.15) & (nCount_RNA > 2000 & nCount_RNA < 4000))
pre_regress_all_data_list$B1 <- subset(x = pre_regress_all_data_list$B1, subset = (nFeature_RNA > 250 & nFeature_RNA < 2000) & (percent.mito < 0.2) & (nCount_RNA > 250 & nCount_RNA < 5000))
pre_regress_all_data_list$B3 <- subset(x = pre_regress_all_data_list$B3, subset = (nFeature_RNA > 250 & nFeature_RNA < 2000) & (percent.mito < 0.2) & (nCount_RNA > 250 & nCount_RNA < 5000))
pre_regress_all_data_list$Indrop_uninj <- subset(x = pre_regress_all_data_list$Indrop_uninj, subset = (nFeature_RNA >  500 & nFeature_RNA < 1500) & (percent.mito < 0.15) & (nCount_RNA > 2000 & nCount_RNA < 4000))
```


# Structure {.tabset}

```{r}
all_data.pre_integrated <-  pre_regress_all_data

all_data.pre_integrated<- NormalizeData(object = all_data.pre_integrated, verbose = FALSE)
all_data.pre_integrated <- FindVariableFeatures(object = all_data.pre_integrated, 
                                             selection.method = "vst", nfeatures = 2000, verbose = FALSE)

all_data.pre_integrated <- ScaleData(object = all_data.pre_integrated,vars.to.regress = params$vars_to_regress,verbose = FALSE)
all_data.pre_integrated <- RunPCA(object = all_data.pre_integrated, verbose = FALSE)
all_data.pre_integrated <- RunUMAP(object = all_data.pre_integrated, reduction = "pca",dims = 1:30)
all_data.pre_integrated <- RunTSNE(object = all_data.pre_integrated, reduction = "pca",dims = 1:30)
```

## UMAP {.tabset}
```{r}
p1 <- DimPlot(object = all_data.pre_integrated, reduction = "umap", group.by = "sample")
p2 <- DimPlot(object = all_data.pre_integrated, reduction = "umap", group.by = "tech")
p3 <- DimPlot(object = all_data.pre_integrated, reduction = "umap", group.by = "injured_st")
```

### By sample

```{r}
show(p1)
```

### By tech

```{r}
show(p2)

```

### By injured status

```{r}
show(p3)
```

## TSNE {.tabset}

```{r}
p4 <- DimPlot(object = all_data.pre_integrated, reduction = "tsne", group.by = "sample")
p5 <- DimPlot(object = all_data.pre_integrated, reduction = "tsne", group.by = "tech")
p6 <- DimPlot(object = all_data.pre_integrated, reduction = "tsne", group.by = "injured_st")
```

### By sample

```{r}
show(p4)
```

### By tech

```{r}
show(p5)
```

### By injured status

```{r}
show(p6)
```

# Integrate

## Injured

```{r}
pre_regress_all_data_list_inj <- pre_regress_all_data_list[c("B2","B4","Indrop_PC1","Indrop_PC2_1")]
```


```{r}
for (i in 1:length(x = pre_regress_all_data_list_inj)) {
  pre_regress_all_data_list_inj[[i]] <- NormalizeData(object = pre_regress_all_data_list_inj[[i]], verbose = FALSE)
  pre_regress_all_data_list_inj[[i]] <- FindVariableFeatures(object = pre_regress_all_data_list_inj[[i]], 
                                             selection.method = "vst", nfeatures = 2000, verbose = FALSE)
}
# finding anchors

reference.list_inj <- pre_regress_all_data_list_inj[c("B2","B4","Indrop_PC1","Indrop_PC2_1")]
pre_regress_all_data_inj.anchors <- FindIntegrationAnchors(object.list = reference.list_inj, dims = 1:30)
pre_regress_all_data.integrated_inj <- IntegrateData(anchorset = pre_regress_all_data_inj.anchors, dims = 1:30)
DefaultAssay(object = pre_regress_all_data.integrated_inj) <- "integrated"
all_data.integrated_inj <- ScaleData(object = pre_regress_all_data.integrated_inj,vars.to.regress = params$vars_to_regress,verbose = FALSE)
DefaultAssay(object = all_data.integrated_inj) <- "integrated"
all_data.integrated_inj <- RunPCA(object = all_data.integrated_inj, verbose = FALSE)

```


```{r}
all_data.integrated_inj <- RunUMAP(object = all_data.integrated_inj, reduction = "pca",dims = 1:30)
all_data.integrated_inj <- RunTSNE(object = all_data.integrated_inj, reduction = "pca",dims = 1:30)
```


### UMAP {.tabset}
```{r}
p1 <- DimPlot(object = all_data.integrated_inj, reduction = "umap", group.by = "sample")
p2 <- DimPlot(object = all_data.integrated_inj, reduction = "umap", group.by = "tech")
p3 <- DimPlot(object = all_data.integrated_inj, reduction = "umap", group.by = "injured_st")
```

#### By sample

```{r}
show(p1)
```

#### By tech

```{r}
show(p2)
```

#### By injured status

```{r}
show(p3)
```

### TSNE {.tabset}

```{r}
p4 <- DimPlot(object = all_data.integrated_inj, reduction = "tsne", group.by = "sample")
p5 <- DimPlot(object = all_data.integrated_inj, reduction = "tsne", group.by = "tech")
p6 <- DimPlot(object = all_data.integrated_inj, reduction = "tsne", group.by = "injured_st")
```

#### By sample

```{r}
show(p4)
```

#### By tech

```{r}
show(p5)
```

#### By injured status

```{r}
show(p6)
```



### Clusters {.tabset}

```{r}
# clustering, finding maker genes
all_data.integrated_inj <- FindNeighbors(object = all_data.integrated_inj, dims = 1:30)
```


We explore different levels of resolution.

```{r cluster_plots_diff_resolutions_inj, results= "asis"}
for (res in seq(0.1,2,0.1)){
  cat("\n")
  cat("\n####","Cluster resolution: ",res,"{.tabset}\n")
      all_data.integrated_inj <- FindClusters(all_data.integrated_inj, resolution = res,  verbose = FALSE)
      cat("\n##### UMAP\n")
        p1 <- DimPlot(object = all_data.integrated_inj, reduction = 'umap',  label = TRUE)
        print(p1)
        cat("\n")
      cat("\n##### TSNE\n")
        p2 <- DimPlot(object = all_data.integrated_inj, reduction = 'tsne', label = TRUE)
        print(p2)
        cat("\n")
  cat("\n")
}
```



### Markers 

```{r}
selected_genes <- rio::import("./markers.csv")
```

Genes:

```{r}
DT::datatable(selected_genes)
```


#### UMAP{.tabset}

```{r, results = "asis"}
selected_genes <- selected_genes %>% dplyr::filter(geneID %in% rownames(all_data.integrated_inj))


selected_genes <- selected_genes[rowSums(as.matrix(GetAssayData(all_data.integrated_inj)[selected_genes$geneID,]))>0,]

plot_feature_plot_wrapper <- function(obj,sub_df){
    p <- FeaturePlot(obj, features = sub_df[2],cols = c("grey", "blue"), 
reduction = "umap",min.cutoff = 1)
    if(is.na(sub_df[3])){
       p <- p + ggtitle(sub_df[2]) %>% invisible()
    }else{
       p <- p + ggtitle(sub_df[3]) %>% invisible()
    }
    return(p)
}

for(cell_t in unique(selected_genes$cellType)){
    cat("\n")
    cat("#####",cell_t," {.tabset} \n")
    df <- selected_genes %>% dplyr::filter(cellType == cell_t)
    df_split <- split(df, ceiling(seq_along(df$geneID)/6))
    for(i in names(df_split)){
        cat("\n")
        cat("######",paste(cell_t,i,sep="-"),"\n")
        
        plot_list <- apply(df_split[[i]],1,FUN = function(x){plot_feature_plot_wrapper(all_data.integrated_inj,x)})
        
        
        p_l <- plot_grid(plotlist = plot_list,ncol = 2)
        print(p_l)
        cat("\n")
    }
    cat("\n")
}

```


#### TSNE{.tabset}


```{r, results = "asis"}
plot_feature_plot_wrapper <- function(obj,sub_df){
    p <- FeaturePlot(obj, features = sub_df[2],cols = c("grey", "blue"), 
reduction = "tsne",min.cutoff = 1)
    if(is.na(sub_df[3])){
       p <- p + ggtitle(sub_df[2]) %>% invisible()
    }else{
       p <- p + ggtitle(sub_df[3]) %>% invisible()
    }
    return(p)
}

for(cell_t in unique(selected_genes$cellType)){
    cat("\n")
    cat("#####",cell_t," {.tabset} \n")
    df <- selected_genes %>% dplyr::filter(cellType == cell_t)
    df_split <- split(df, ceiling(seq_along(df$geneID)/6))
    for(i in names(df_split)){
        cat("\n")
        cat("######",paste(cell_t,i,sep="-"),"\n")
        
        plot_list <- apply(df_split[[i]],1,FUN = function(x){plot_feature_plot_wrapper(all_data.integrated_inj,x)})
        
        
        p_l <- plot_grid(plotlist = plot_list,ncol = 2)
        print(p_l)
        cat("\n")
    }
    cat("\n")
}

```





## UnInjured

```{r}
pre_regress_all_data_list_uninj <- pre_regress_all_data_list[c("B1","B3","Indrop_blood2_uninj","Indrop_blood3_uninj")]
```


```{r}
for (i in 1:length(x = pre_regress_all_data_list_uninj)) {
  pre_regress_all_data_list_uninj[[i]] <- NormalizeData(object = pre_regress_all_data_list_uninj[[i]], verbose = FALSE)
  pre_regress_all_data_list_uninj[[i]] <- FindVariableFeatures(object = pre_regress_all_data_list_uninj[[i]], 
                                             selection.method = "vst", nfeatures = 2000, verbose = FALSE)
}
# finding anchors

reference.list_uninj <- pre_regress_all_data_list_uninj[c("B1","B3","Indrop_blood2_uninj","Indrop_blood3_uninj")]
pre_regress_all_data_uninj.anchors <- FindIntegrationAnchors(object.list = reference.list_uninj, dims = 1:30)
pre_regress_all_data.integrated_uninj <- IntegrateData(anchorset = pre_regress_all_data_uninj.anchors, dims = 1:30)
DefaultAssay(object = pre_regress_all_data.integrated_uninj) <- "integrated"
all_data.integrated_uninj <- ScaleData(object = pre_regress_all_data.integrated_uninj,vars.to.regress = params$vars_to_regress,verbose = FALSE)
DefaultAssay(object = all_data.integrated_uninj) <- "integrated"
all_data.integrated_uninj <- RunPCA(object = all_data.integrated_uninj, verbose = FALSE)

```


```{r}
all_data.integrated_uninj <- RunUMAP(object = all_data.integrated_uninj, reduction = "pca",dims = 1:30)
all_data.integrated_uninj <- RunTSNE(object = all_data.integrated_uninj, reduction = "pca",dims = 1:30)
```


### UMAP {.tabset}
```{r}
p1 <- DimPlot(object = all_data.integrated_uninj, reduction = "umap", group.by = "sample")
p2 <- DimPlot(object = all_data.integrated_uninj, reduction = "umap", group.by = "tech")
p3 <- DimPlot(object = all_data.integrated_uninj, reduction = "umap", group.by = "injured_st")
```

#### By sample

```{r}
show(p1)
```

#### By tech

```{r}
show(p2)
```

#### By uninjured status

```{r}
show(p3)
```

### TSNE {.tabset}

```{r}
p4 <- DimPlot(object = all_data.integrated_uninj, reduction = "tsne", group.by = "sample")
p5 <- DimPlot(object = all_data.integrated_uninj, reduction = "tsne", group.by = "tech")
p6 <- DimPlot(object = all_data.integrated_uninj, reduction = "tsne", group.by = "injured_st")
```

#### By sample

```{r}
show(p4)
```

#### By tech

```{r}
show(p5)
```

#### By uninjured status

```{r}
show(p6)
```

### Clusters {.tabset}

```{r}
# clustering, finding maker genes
all_data.integrated_uninj <- FindNeighbors(object = all_data.integrated_uninj, dims = 1:30)
```


We explore different levels of resolution.

```{r cluster_plots_diff_resolutions_ununij, results= "asis"}
for (res in seq(0.1,2,0.1)){
  cat("\n")
  cat("\n####","Cluster resolution: ",res,"{.tabset}\n")
      all_data.integrated_uninj <- FindClusters(all_data.integrated_uninj, resolution = res,  verbose = FALSE)
      cat("\n##### UMAP\n")
        p1 <- DimPlot(object = all_data.integrated_uninj, reduction = 'umap',  label = TRUE)
        print(p1)
        cat("\n")
      cat("\n##### TSNE\n")
        p2 <- DimPlot(object = all_data.integrated_uninj, reduction = 'tsne', label = TRUE)
        print(p2)
        cat("\n")
  cat("\n")
}
```


### Markers 

```{r}
selected_genes <- rio::import("./markers.csv")
```

Genes:

```{r}
DT::datatable(selected_genes)
```


#### UMAP{.tabset}

```{r, results = "asis"}
selected_genes <- selected_genes %>% dplyr::filter(geneID %in% rownames(all_data.integrated_uninj))


selected_genes <- selected_genes[rowSums(as.matrix(GetAssayData(all_data.integrated_uninj)[selected_genes$geneID,]))>0,]

plot_feature_plot_wrapper <- function(obj,sub_df){
    p <- FeaturePlot(obj, features = sub_df[2],cols = c("grey", "blue"), 
reduction = "umap",min.cutoff = 1)
    if(is.na(sub_df[3])){
       p <- p + ggtitle(sub_df[2]) %>% invisible()
    }else{
       p <- p + ggtitle(sub_df[3]) %>% invisible()
    }
    return(p)
}

for(cell_t in unique(selected_genes$cellType)){
    cat("\n")
    cat("#####",cell_t," {.tabset} \n")
    df <- selected_genes %>% dplyr::filter(cellType == cell_t)
    df_split <- split(df, ceiling(seq_along(df$geneID)/6))
    for(i in names(df_split)){
        cat("\n")
        cat("######",paste(cell_t,i,sep="-"),"\n")
        
        plot_list <- apply(df_split[[i]],1,FUN = function(x){plot_feature_plot_wrapper(all_data.integrated_uninj,x)})
        
        
        p_l <- plot_grid(plotlist = plot_list,ncol = 2)
        print(p_l)
        cat("\n")
    }
    cat("\n")
}

```


#### TSNE{.tabset}


```{r, results = "asis"}
plot_feature_plot_wrapper <- function(obj,sub_df){
    p <- FeaturePlot(obj, features = sub_df[2],cols = c("grey", "blue"), 
reduction = "tsne",min.cutoff = 1)
    if(is.na(sub_df[3])){
       p <- p + ggtitle(sub_df[2]) %>% invisible()
    }else{
       p <- p + ggtitle(sub_df[3]) %>% invisible()
    }
    return(p)
}

for(cell_t in unique(selected_genes$cellType)){
    cat("\n")
    cat("#####",cell_t," {.tabset} \n")
    df <- selected_genes %>% dplyr::filter(cellType == cell_t)
    df_split <- split(df, ceiling(seq_along(df$geneID)/6))
    for(i in names(df_split)){
        cat("\n")
        cat("######",paste(cell_t,i,sep="-"),"\n")
        
        plot_list <- apply(df_split[[i]],1,FUN = function(x){plot_feature_plot_wrapper(all_data.integrated_uninj,x)})
        
        
        p_l <- plot_grid(plotlist = plot_list,ncol = 2)
        print(p_l)
        cat("\n")
    }
    cat("\n")
}

```


## All

```{r}
all_data_full_list <- list(all_data.integrated_inj = all_data.integrated_inj,all_data.integrated_uninj = all_data.integrated_uninj)
```


```{r, eval = FALSE}
for (i in 1:length(x = all_data_full_list)) {
  all_data_full_list[[i]] <- NormalizeData(object = all_data_full_list[[i]], verbose = FALSE)
  all_data_full_list[[i]] <- FindVariableFeatures(object = all_data_full_list[[i]], 
                                             selection.method = "vst", nfeatures = 2000, verbose = FALSE)
}

```

```{r}
# finding anchors

reference.list_all <- all_data_full_list[c("all_data.integrated_inj","all_data.integrated_uninj")
]
all_data_full_.anchors <- FindIntegrationAnchors(object.list = reference.list_all, dims = 1:30)
all_data_full_.integrated <- IntegrateData(anchorset = all_data_full_.anchors, dims = 1:30)
DefaultAssay(object = all_data_full_.integrated) <- "integrated"
all_data_full_.integrated <- ScaleData(object = all_data_full_.integrated,vars.to.regress = params$vars_to_regress,verbose = FALSE)
DefaultAssay(object = all_data_full_.integrated) <- "integrated"
all_data_full_.integrated <- RunPCA(object = all_data_full_.integrated, npcs = 30, verbose = FALSE)
all_data_full_.integrated <- RunUMAP(object = all_data_full_.integrated, reduction = "pca",dims = 1:30)
all_data_full_.integrated <- RunTSNE(object = all_data_full_.integrated, reduction = "pca",dims = 1:30)
```

### UMAP {.tabset}
```{r}
p1 <- DimPlot(object = all_data_full_.integrated, reduction = "umap", group.by = "sample")
p2 <- DimPlot(object = all_data_full_.integrated, reduction = "umap", group.by = "tech")
p3 <- DimPlot(object = all_data_full_.integrated, reduction = "umap", group.by = "injured_st")
```

#### By sample

```{r}
show(p1)
```

#### By tech

```{r}
show(p2)
```

#### By injured status

```{r}
show(p3)
```

### TSNE {.tabset}

```{r}
p4 <- DimPlot(object = all_data_full_.integrated, reduction = "tsne", group.by = "sample")
p5 <- DimPlot(object = all_data_full_.integrated, reduction = "tsne", group.by = "tech")
p6 <- DimPlot(object = all_data_full_.integrated, reduction = "tsne", group.by = "injured_st")
```

#### By sample

```{r}
show(p4)
```

#### By tech

```{r}
show(p5)
```

#### By injured status

```{r}
show(p6)
```

# Clusters {.tabset}

```{r}
# clustering, finding maker genes
all_data_full_.integrated <- FindNeighbors(object = all_data_full_.integrated, dims = 1:30)
```


We explore different levels of resolution.

```{r cluster_plots_diff_resolutions, results= "asis"}
for (res in seq(0.1,2,0.1)){
  cat("\n")
  cat("\n##","Cluster resolution: ",res,"{.tabset}\n")
      all_data_full_.integrated <- FindClusters(all_data_full_.integrated, resolution = res,  verbose = FALSE)
      cat("\n### UMAP\n")
        p1 <- DimPlot(object = all_data_full_.integrated, reduction = 'umap', split.by = "injured_st",  label = TRUE)
        print(p1)
        cat("\n")
      cat("\n### TSNE\n")
        p2 <- DimPlot(object = all_data_full_.integrated, reduction = 'tsne', split.by = "injured_st", label = TRUE)
        print(p2)
        cat("\n")
  cat("\n")
}
```


# Markers 

```{r}
selected_genes <- rio::import("./markers.csv")
```

Genes:

```{r}
DT::datatable(selected_genes)
```


## UMAP{.tabset}

```{r, results = "asis"}
selected_genes <- selected_genes %>% dplyr::filter(geneID %in% rownames(all_data_full_.integrated))


selected_genes <- selected_genes[rowSums(as.matrix(GetAssayData(all_data_full_.integrated)[selected_genes$geneID,]))>0,]

plot_feature_plot_wrapper <- function(obj,sub_df){
    p <- FeaturePlot(obj, features = sub_df[2],cols = c("grey", "blue"), 
reduction = "umap",min.cutoff = 1,  split.by = "injured_st")
    if(is.na(sub_df[3])){
       p <- p + ggtitle(sub_df[2]) %>% invisible()
    }else{
       p <- p + ggtitle(sub_df[3]) %>% invisible()
    }
    return(p)
}

for(cell_t in unique(selected_genes$cellType)){
    cat("\n")
    cat("###",cell_t," {.tabset} \n")
    df <- selected_genes %>% dplyr::filter(cellType == cell_t)
    df_split <- split(df, ceiling(seq_along(df$geneID)/4))
    for(i in names(df_split)){
        cat("\n")
        cat("####",paste(cell_t,i,sep="-"),"\n")
        
        plot_list <- apply(df_split[[i]],1,FUN = function(x){plot_feature_plot_wrapper(all_data_full_.integrated,x)})
        
        
        p_l <- plot_grid(plotlist = plot_list,ncol = 2)
        print(p_l)
        cat("\n")
    }
    cat("\n")
}

```


## TSNE{.tabset}


```{r, results = "asis"}
plot_feature_plot_wrapper <- function(obj,sub_df){
    p <- FeaturePlot(obj, features = sub_df[2],cols = c("grey", "blue"), 
reduction = "tsne",min.cutoff = 1,  split.by = "injured_st")
    if(is.na(sub_df[3])){
       p <- p + ggtitle(sub_df[2]) %>% invisible()
    }else{
       p <- p + ggtitle(sub_df[3]) %>% invisible()
    }
    return(p)
}

for(cell_t in unique(selected_genes$cellType)){
    cat("\n")
    cat("###",cell_t," {.tabset} \n")
    df <- selected_genes %>% dplyr::filter(cellType == cell_t)
    df_split <- split(df, ceiling(seq_along(df$geneID)/4))
    for(i in names(df_split)){
        cat("\n")
        cat("####",paste(cell_t,i,sep="-"),"\n")
        
        plot_list <- apply(df_split[[i]],1,FUN = function(x){plot_feature_plot_wrapper(all_data_full_.integrated,x)})
        
        
        p_l <- plot_grid(plotlist = plot_list,ncol = 2)
        print(p_l)
        cat("\n")
    }
    cat("\n")
}

```

